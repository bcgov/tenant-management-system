{{- if and .Values.global.secrets .Values.global.secrets.enabled }}
{{/* Set database user */}}
{{- $databaseUser := "app" }}
{{- $databaseAlias := .Values.global.databaseAlias | default .Release.Name }}
{{- $databaseName := "app" }}

{{/* Initialize variables */}}
{{- $databasePassword := "" }}
{{- $hostWithoutPort := "" }}

{{/* Handle PostgreSQL for PR and Dev environments */}}
{{- if and (or (contains "-pr-" .Release.Name) (contains "-dev" .Release.Name)) (index .Values "postgresql-pr" "enabled") }}
  {{- $hostWithoutPort = printf "%s-postgresql" .Release.Name }}

  {{/* Generate deterministic password - same as in postgresql-pr.yaml */}}
  {{- $generatedPassword := printf "%s-pr-db-pass" .Release.Name | sha256sum | trunc 32 }}

  {{/* Check if PostgreSQL secret already exists (for updates) */}}
  {{- $existingPgSecret := (lookup "v1" "Secret" .Release.Namespace (printf "%s-postgresql" .Release.Name)) }}

  {{- if $existingPgSecret }}
    {{/* Use existing password - retrieve plain password from secret */}}
    {{- $passwordB64 := get $existingPgSecret.data "database-password" }}
    {{- $databasePassword = $passwordB64 | b64dec }}
  {{- else }}
    {{/* First install - use generated password */}}
    {{- $databasePassword = $generatedPassword }}
  {{- end }}

  {{- $databaseName = "app" }}

{{- else }}
  {{/* Production/Test environment using Crunchy */}}
  {{- $hostWithoutPort = printf "%s-postgres" $databaseAlias }}
  {{- $secretName := printf "%s-pguser-%s" $databaseAlias $databaseUser }}
  {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace $secretName) }}

  {{- if $secretObj }}
    {{- $secretData := (get $secretObj "data") }}
    {{/* Decode the password from Crunchy secret (it's stored base64-encoded in Kubernetes) */}}
    {{- $databasePassword = get $secretData "password" | b64dec }}
    {{- $databaseName = b64dec (get $secretData "dbname") | default "app" }}
  {{- else if .Values.global.secrets.databasePassword }}
    {{/* Fallback: use password from Helm values if Crunchy secret doesn't exist yet */}}
    {{- $databasePassword = .Values.global.secrets.databasePassword }}
    {{/* Database name can also come from values if needed */}}
    {{- $databaseName = .Values.global.secrets.databaseName | default "app" }}
  {{- else }}
    {{- fail (printf "Crunchy secret %s not found in namespace %s and no databasePassword provided in values" $secretName .Release.Namespace) }}
  {{- end }}
{{- end }}

{{/* Determine database host based on environment */}}
{{- $host := "" }}
{{- if and (or (contains "-pr-" .Release.Name) (contains "-dev" .Release.Name)) (index .Values "postgresql-pr" "enabled") }}
  {{- $host = printf "%s:%s" $hostWithoutPort "5432" }}
{{- else }}
  {{- $host = printf "%s:%s" (printf "%s-pgbouncer" .Values.global.databaseAlias) "5432" }}
{{- end }}
{{- $databaseJDBCURLNoCreds := printf "jdbc:postgresql://%s/%s" $host $databaseName }}

{{/* Determine backend database host based on environment */}}
{{- $postgresHost := "" }}
{{- if and (or (contains "-pr-" .Release.Name) (contains "-dev" .Release.Name)) (index .Values "postgresql-pr" "enabled") }}
  {{- $postgresHost = $hostWithoutPort }}
{{- else }}
  {{- $postgresHost = printf "%s-pgbouncer" .Values.global.databaseAlias }}
{{- end }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-backend
  labels: {{- include "labels" . | nindent 4 }}
  {{- if .Values.global.secrets.persist }}
  annotations:
    helm.sh/resource-policy: keep
  {{- end }}
type: Opaque
data:
  # Database connection settings
  POSTGRES_PASSWORD: {{ $databasePassword | b64enc | quote }}
  POSTGRES_USER: {{ $databaseUser | b64enc | quote }}
  POSTGRES_DATABASE: {{ $databaseName | b64enc | quote }}
  POSTGRES_HOST: {{ $postgresHost | b64enc | quote }}
  POSTGRES_PORT: {{ "5432" | b64enc | quote }}

  # Application settings
  PORT: {{ .Values.backend.environment.port | b64enc | quote }}
  ALLOWED_ORIGINS: {{ .Values.backend.environment.allowedOrigins | b64enc | quote }}
  NODE_ENV: {{ .Values.global.config.nodeEnv | b64enc | quote }}
  LOG_LEVEL: {{ .Values.backend.environment.logLevel | b64enc | quote }}

  # SSO/Auth settings (placeholders - updated post-deployment)
  BCGOV_SSO_API_URL: {{ .Values.backend.environment.bcgovSsoApiUrl | b64enc | quote }}
  BCGOV_TOKEN_URL: {{ .Values.backend.environment.bcgovTokenUrl | b64enc | quote }}
  BCGOV_SSO_API_CLIENT_ID: {{ "placeholder" | b64enc | quote }}
  BCGOV_SSO_API_CLIENT_SECRET: {{ "placeholder" | b64enc | quote }}
  TMS_AUDIENCE: {{ .Values.backend.environment.tmsAudience | b64enc | quote }}
  JWKS_URI: {{ .Values.backend.environment.jwksUri | b64enc | quote }}
  ISSUER: {{ .Values.backend.environment.issuer | b64enc | quote }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Release.Name }}-flyway
  labels: {{- include "labels" . | nindent 4 }}
  {{- if .Values.global.secrets.persist }}
  annotations:
    helm.sh/resource-policy: keep
  {{- end }}
type: Opaque
data:
  FLYWAY_URL: {{ $databaseJDBCURLNoCreds | b64enc | quote }}
  FLYWAY_USER: {{ $databaseUser | b64enc | quote }}
  FLYWAY_PASSWORD: {{ $databasePassword | b64enc | quote }}
{{- end }}
